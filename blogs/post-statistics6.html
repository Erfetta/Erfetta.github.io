<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Online Mean & Variance ‚Äî Recurrences and Algorithms</title>
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" href="../images/favicon.png" type="image/png">
</head>
<body>
  <header>
    <h1>üìö My Blog</h1>
    <nav>
      <a href="../index.html">Home</a>
      <a href="blog.html">Blog</a>
    </nav>
  </header>

  <main class="container">

    <!-- Description -->
    <section>
      <article class="card">
        <h2>üßÆ Analytical Task ‚Äî Recurrence Proofs & Online Algorithms</h2>
        <p>
          Goal: derive the simplest proofs for the <strong>recurrence relationships</strong> of the
          arithmetic mean and variance, and implement <strong>online (streaming) algorithms</strong>
          that update statistics incrementally as new data arrive. Batch algorithms are discouraged
          (less efficient, more memory-hungry, and potentially numerically unstable).
        </p>
      </article>
    </section>

    <!-- Proofs -->
    <section>
      <article class="card">
        <h2>‚úçÔ∏è Recurrence Relationships ‚Äî Simple Proofs</h2>

        <h3>1) Arithmetic Mean</h3>
        <p>
          Let \( \mu_n = \frac{1}{n}\sum_{i=1}^n x_i \).
          Then
        </p>
        <p><code>
          \mu_n = \frac{1}{n}\bigg(\sum_{i=1}^{n-1} x_i + x_n\bigg)
               = \frac{n-1}{n}\cdot \frac{1}{n-1}\sum_{i=1}^{n-1} x_i + \frac{x_n}{n}
               = \frac{n-1}{n}\mu_{n-1} + \frac{x_n}{n}.
        </code></p>
        <p>
          Rearranging:
          <code>\(\mu_n = \mu_{n-1} + \dfrac{x_n - \mu_{n-1}}{n}\)</code>.
          This gives an <em>online</em> update using only \( \mu_{n-1} \) and \( n \).
        </p>

        <h3>2) Variance (Welford‚Äôs Recurrence)</h3>
        <p>
          Define the running mean \( \mu_n \) as above, and
          \( M2_n = \sum_{i=1}^n (x_i - \mu_n)(x_i - \mu_{n}) \) (the ‚Äúsum of squares of deviations‚Äù).
          When a new sample \( x_n \) arrives:
        </p>
        <ol>
          <li>\(\delta = x_n - \mu_{n-1}\)</li>
          <li>\(\mu_n = \mu_{n-1} + \delta/n\)</li>
          <li>\(\delta' = x_n - \mu_n\)</li>
          <li>\(M2_n = M2_{n-1} + \delta \cdot \delta'\)</li>
        </ol>
        <p>
          Sketch: expand \(M2_n = \sum (x_i-\mu_n)^2\) and subtract \(M2_{n-1}=\sum_{i=1}^{n-1}(x_i-\mu_{n-1})^2\).
          Terms collapse because \(\sum_{i=1}^{n-1}(x_i-\mu_{n-1})=0\), yielding
          \(M2_n = M2_{n-1} + \delta(x_n-\mu_n) = M2_{n-1} + \delta\delta'\).
        </p>
        <p>
          Then:
          <br>‚Ä¢ <strong>Population variance</strong>: \( \sigma_n^2 = \dfrac{M2_n}{n} \)
          <br>‚Ä¢ <strong>Sample variance</strong>: \( s_n^2 = \dfrac{M2_n}{n-1} \) (for \(n \ge 2\))
        </p>
        <p>
          This recurrence is <strong>numerically stable</strong> and avoids catastrophic cancellation typical of
          naive formulas like \(E[X^2]-E[X]^2\) computed in batch.
        </p>
      </article>
    </section>

    <!-- Online JS Implementation -->
    <section>
      <article class="card">
        <h2>‚öôÔ∏è Online Algorithms (JavaScript)</h2>
        <p>
          The following class maintains <code>n</code>, <code>mean</code>, and <code>M2</code> and supports
          fast, numerically stable updates one sample at a time.
        </p>

<pre><code>// Online mean & variance via Welford
class OnlineStats {
  constructor() {
    this.n = 0;
    this.mean = 0;
    this.M2 = 0; // sum of squares of deviations from the mean
  }

  add(x) {
    this.n += 1;
    const delta = x - this.mean;
    this.mean += delta / this.n;
    const delta2 = x - this.mean;
    this.M2 += delta * delta2;
    return this; // chainable
  }

  count() { return this.n; }
  getMean() { return this.mean; }

  // population variance (divide by n)
  getVarPop() { return this.n &gt; 0 ? this.M2 / this.n : NaN; }

  // sample variance (unbiased; divide by n-1)
  getVarSample() { return this.n &gt; 1 ? this.M2 / (this.n - 1) : NaN; }

  getSdPop() { const v = this.getVarPop(); return isNaN(v) ? NaN : Math.sqrt(v); }
  getSdSample() { const v = this.getVarSample(); return isNaN(v) ? NaN : Math.sqrt(v); }

  reset() { this.n = 0; this.mean = 0; this.M2 = 0; }
}
</code></pre>

      </article>
    </section>

    <!-- Interactive Demo -->
    <section>
      <article class="card">
        <h2>üß™ Interactive Demo</h2>
        <p>Insert numbers (comma/space/newline separated) and update the streaming statistics:</p>

        <div>
          <textarea id="values" rows="5" placeholder="e.g. 1, 2, 2.5  3
4  10"></textarea>
        </div>
        <div style="margin-top:8px;">
          <button id="addBtn"><i class="fa-solid fa-plus"></i> Add values</button>
          <button id="randBtn"><i class="fa-solid fa-shuffle"></i> Add 100 N(0,1)</button>
          <button id="resetBtn"><i class="fa-solid fa-rotate-left"></i> Reset</button>
        </div>

        <div style="margin-top:12px;">
          <p><strong>n:</strong> <span id="nOut">0</span></p>
          <p><strong>mean (Œº):</strong> <span id="meanOut">‚Äì</span></p>
          <p><strong>var_pop (œÉ¬≤):</strong> <span id="vpopOut">‚Äì</span></p>
          <p><strong>sd_pop (œÉ):</strong> <span id="sdpopOut">‚Äì</span></p>
          <p><strong>var_sample (s¬≤):</strong> <span id="vsOut">‚Äì</span></p>
          <p><strong>sd_sample (s):</strong> <span id="sdsOut">‚Äì</span></p>
        </div>

        <details style="margin-top:12px;">
          <summary><strong>Optional test (sanity check)</strong></summary>
          <p>
            For verification only, we compare against a one-shot calculation on the current dataset
            (this is <em>not</em> used in the streaming algorithm).
          </p>
          <button id="testBtn"><i class="fa-solid fa-vial"></i> Run check</button>
          <pre id="testLog"></pre>
        </details>
      </article>
    </section>

    <!-- Discussion -->
    <section>
      <article class="card">
        <h2>üß† Why Online Beats Batch (here)</h2>
        <ul>
          <li><strong>Time &amp; memory:</strong> O(1) per update; no need to store all past samples.</li>
          <li><strong>Numerical stability:</strong> avoids catastrophic cancellation present in <code>E[X^2]-E[X]^2</code> when values are large/close.</li>
          <li><strong>Streaming-ready:</strong> perfect for data streams, telemetry, logging, rolling aggregates.</li>
        </ul>
      </article>
    </section>

  </main>

  <footer>
    <p>How to contact me:</p>
    <ul class="social-icons">
      <li><a href="mailto:fettuccia57@gmail.com"><i class="fas fa-envelope"></i></a></li>
      <li><a href="https://www.linkedin.com/in/simone-fettuccia-a88086332" target="_blank"><i class="fab fa-linkedin"></i></a></li>
      <li><a href="https://github.com/Erfetta" target="_blank"><i class="fab fa-github"></i></a></li>
    </ul>
  </footer>

  <script>
/*** Online mean & variance (Welford) ***/
class OnlineStats {
  constructor() {
    this.n = 0;
    this.mean = 0;
    this.M2 = 0;
  }
  add(x) {
    this.n += 1;
    const delta = x - this.mean;
    this.mean += delta / this.n;
    const delta2 = x - this.mean;
    this.M2 += delta * delta2;
    return this;
  }
  count() { return this.n; }
  getMean() { return this.mean; }
  getVarPop() { return this.n > 0 ? this.M2 / this.n : NaN; }
  getVarSample() { return this.n > 1 ? this.M2 / (this.n - 1) : NaN; }
  getSdPop() { const v = this.getVarPop(); return isNaN(v) ? NaN : Math.sqrt(v); }
  getSdSample() { const v = this.getVarSample(); return isNaN(v) ? NaN : Math.sqrt(v); }
  reset() { this.n = 0; this.mean = 0; this.M2 = 0; }
}

/*** UI wiring ***/
const stats = new OnlineStats();
const $ = (id) => document.getElementById(id);

function parseValues(text) {
  return text.split(/[\s,;]+/).map(Number).filter(v => Number.isFinite(v));
}
function updateDisplay() {
  $("nOut").textContent = stats.count();
  $("meanOut").textContent = format(stats.getMean());
  $("vpopOut").textContent = format(stats.getVarPop());
  $("sdpopOut").textContent = format(stats.getSdPop());
  $("vsOut").textContent = format(stats.getVarSample());
  $("sdsOut").textContent = format(stats.getSdSample());
}
function format(x) {
  return Number.isFinite(x) ? (Math.abs(x) >= 1e6 || Math.abs(x) < 1e-4 ? x.toExponential(6) : x.toFixed(6)) : "‚Äì";
}

$("addBtn").addEventListener("click", () => {
  const vals = parseValues($("values").value);
  vals.forEach(v => stats.add(v));
  updateDisplay();
});

$("randBtn").addEventListener("click", () => {
  // Box‚ÄìMuller to generate 100 samples ~ N(0,1)
  for (let i = 0; i < 50; i++) {
    const u1 = Math.random(), u2 = Math.random();
    const r = Math.sqrt(-2 * Math.log(u1));
    const z1 = r * Math.cos(2 * Math.PI * u2);
    const z2 = r * Math.sin(2 * Math.PI * u2);
    stats.add(z1); stats.add(z2);
  }
  updateDisplay();
});

$("resetBtn").addEventListener("click", () => {
  stats.reset();
  $("values").value = "";
  $("testLog").textContent = "";
  updateDisplay();
});

/*** Optional sanity check (not used for production calc) ***/
$("testBtn").addEventListener("click", () => {
  const vals = parseValues($("values").value);
  // build a fresh OnlineStats to process exactly these vals
  const s = new OnlineStats();
  vals.forEach(v => s.add(v));
  const mean_online = s.getMean();
  const var_online = s.getVarSample();

  // batch (only for verification): mean & sample variance
  const n = vals.length;
  const mean_b = n ? vals.reduce((a,b)=>a+b,0)/n : NaN;
  const var_b = n>1 ? vals.reduce((acc,v)=>acc+(v-mean_b)**2,0)/(n-1) : NaN;

  const lines = [];
  lines.push("n = " + n);
  lines.push("mean_online = " + format(mean_online));
  lines.push("mean_batch  = " + format(mean_b));
  lines.push("s2_online   = " + format(var_online));
  lines.push("s2_batch    = " + format(var_b));
  lines.push("abs diff mean = " + format(Math.abs(mean_online - mean_b)));
  lines.push("abs diff s2   = " + format(Math.abs(var_online - var_b)));
  $("testLog").textContent = lines.join("\n");
});

// init
updateDisplay();
  </script>
</body>
</html>
